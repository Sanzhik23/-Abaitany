<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>АБАЙ ӘЛЕМІ — Даналық жолы</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* НЕГІЗГІ СТИЛЬДЕР */
        :root { --gold: #d4af37; --brown: #2c1e10; --bg: #fdf8f2; --white: #ffffff; --green: #28a745; --red: #dc3545; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--brown); margin: 0; min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* ЭКРАНДАР */
        .screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; }
        .abai-portrait { width: 180px; height: 180px; border-radius: 50%; border: 5px solid var(--gold); object-fit: cover; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: fadeIn 1.5s; }
        .speech-bubble { background: var(--white); padding: 20px; border-radius: 15px; border: 2px solid var(--gold); max-width: 450px; margin-bottom: 20px; font-family: 'Playfair Display', serif; font-size: 1.2rem; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        
        /* АВТОРИЗАЦИЯ */
        .auth-box { background: var(--white); padding: 40px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); width: 100%; max-width: 350px; border-top: 5px solid var(--gold); animation: slideUp 0.5s; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        .btn { background: var(--brown); color: var(--gold); padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; margin-top: 10px; }
        .btn:hover { background: #4a3b2a; transform: translateY(-2px); }

        /* HEADER ЖӘНЕ NAV */
        header { background: var(--brown); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .progress-bar-container { width: 150px; height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.5s; }
        nav { background: #3d2b1a; padding: 10px; display: flex; justify-content: center; position: sticky; top: 0; z-index: 100; flex-wrap: wrap; }
        nav a { color: rgba(255,255,255,0.8); text-decoration: none; padding: 8px 15px; cursor: pointer; border-radius: 5px; margin: 0 5px; }
        nav a:hover, nav a.active { background: var(--gold); color: var(--brown); font-weight: bold; }

        /* КОНТЕНТ */
        .content { max-width: 900px; margin: 20px auto; padding: 25px; background: var(--white); border-radius: 15px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .content.active { display: block; }
        .video-box { position: relative; padding-bottom: 56.25%; height: 0; background: #000; border-radius: 10px; overflow: hidden; margin: 20px 0; border: 2px solid var(--brown); }
        .video-box video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .text-box { background: #fffcf5; padding: 30px; border-radius: 10px; border-left: 5px solid var(--gold); line-height: 1.8; text-align: justify; white-space: pre-line; }

        /* ЧАТ ЖӘНЕ ПІКІРЛЕР */
        #reviews-list { max-height: 500px; overflow-y: auto; display: flex; flex-direction: column-reverse; background: #f0f0f0; padding: 15px; border-radius: 10px; }
        .review-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--brown); }
        .admin-reply-box { background: #fff8e1; border-left: 4px solid var(--gold); margin-top: 10px; padding: 10px; font-size: 0.9rem; }

        /* ТЕСТТЕР */
        .quiz-option { display: block; width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; text-align: left; }
        .quiz-option.correct { background: #d4edda !important; color: #155724; }
        .quiz-option.wrong { background: #f8d7da !important; color: #721c24; }
        .score-circle { width: 100px; height: 100px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; margin: 20px auto; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="intro-screen" class="screen">
        <img src="abai.jpg" class="abai-portrait" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/6/66/Abay_Qunanbayuli.jpg'">
        <div class="speech-bubble" id="type-text"></div>
        <button class="btn" id="start-btn" onclick="goToAuth()" style="display:none; width: auto;">БАСТАУ</button>
    </div>

    <div id="auth-screen" class="screen hidden">
        <div id="login-form" class="auth-box">
            <h2>Кіру</h2>
            <input type="text" id="login-username" placeholder="Логин">
            <input type="password" id="login-password" placeholder="Құпиясөз">
            <button class="btn" onclick="handleLogin()">КІРУ</button>
            <p onclick="toggleAuth('register')" style="cursor:pointer; color:var(--gold); margin-top:15px;">Тіркелу</p>
        </div>
        <div id="register-form" class="auth-box hidden">
            <h2>Тіркелу</h2>
            <input type="text" id="reg-username" placeholder="Жаңа логин">
            <input type="password" id="reg-password" placeholder="Жаңа құпиясөз">
            <button class="btn" onclick="handleRegister()">ТІРКЕЛУ</button>
            <p onclick="toggleAuth('login')" style="cursor:pointer; color:var(--gold); margin-top:15px;">Кіруге оралу</p>
        </div>
        <p id="auth-msg" style="color:var(--red); font-weight:bold;"></p>
    </div>

    <div id="app" class="hidden">
        <header>
            <div>
                <h2 style="margin:0;">АБАЙТАНУ</h2>
                <div id="admin-badge" class="hidden" style="color:var(--gold); font-size:0.8rem;">ADMIN</div>
            </div>
            <div style="text-align:right;">
                <div id="user-display" style="font-weight:bold;">User</div>
                <div class="progress-bar-container"><div class="progress-fill" id="global-progress"></div></div>
                <small id="progress-text">0/45 сөз</small>
                <button onclick="logout()" style="background:none; border:1px solid white; color:white; cursor:pointer; padding:2px 5px; margin-top:5px;">Шығу</button>
            </div>
        </header>

        <nav>
            <a onclick="tab(0)" class="nav-link active">Қара сөздер</a>
            <a onclick="tab(1)" class="nav-link">Комикстер</a>
            <a onclick="tab(2)" class="nav-link">Тесттер</a>
            <a onclick="tab(3)" class="nav-link">Пікірлер (Online)</a>
        </nav>

        <main>
            <div id="tab-0" class="content active">
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="btn" style="width:50px;" onclick="move(-1, 'soz-select')">←</button>
                    <select id="soz-select" onchange="loadContent(this.value)" style="flex-grow:1; padding:10px;"></select>
                    <button class="btn" style="width:50px;" onclick="move(1, 'soz-select')">→</button>
                </div>
                <div id="soz-view"></div>
            </div>

            <div id="tab-1" class="content">
                <select id="comic-select" onchange="loadComic(this.value)" style="width:100%; padding:10px; margin-bottom:20px;"></select>
                <div id="comic-view" style="text-align:center;"></div>
            </div>

            <div id="tab-2" class="content">
                <select id="quiz-select" onchange="loadQuiz(this.value)" style="width:100%; padding:10px; margin-bottom:20px;"></select>
                <div id="quiz-container" class="hidden">
                    <div id="quiz-active-area"></div>
                </div>
            </div>

            <div id="tab-3" class="content">
                <h2>Пікірлер мен Талқылау</h2>
                <textarea id="review-input" rows="3" placeholder="Ойыңызды жазыңыз..."></textarea>
                <button class="btn" onclick="sendReview()">Жіберу</button>
                <div id="reviews-list" style="margin-top:20px;"></div>
            </div>
        </main>
    </div>

    <script src="data.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase Конфигурациясы (СІЗДІҢ КІЛТТЕРІҢІЗ)
        const firebaseConfig = {
            apiKey: "AIzaSyBEHbOWsHzVu9cCHI_xTjJ9nUwUSVwj6IM",
            authDomain: "abaialem.firebaseapp.com",
            databaseURL: "https://abaialem-default-rtdb.firebaseio.com",
            projectId: "abaialem",
            storageBucket: "abaialem.firebasestorage.app",
            messagingSenderId: "191818917489",
            appId: "1:191818917489:web:6786f7daeec2d15b21ddd0"
        };

        const app = initializeApp(firebaseConfig);
        const dbRT = getDatabase(app);

        let currentUser = null;
        let isAdmin = false;

        // Глобалды функциялар
        window.goToAuth = () => { document.getElementById('intro-screen').classList.add('hidden'); document.getElementById('auth-screen').classList.remove('hidden'); };
        window.toggleAuth = (m) => { document.getElementById('login-form').classList.toggle('hidden', m==='register'); document.getElementById('register-form').classList.toggle('hidden', m==='login'); };
        window.tab = (n) => { 
            document.querySelectorAll('.content').forEach((c,i) => c.style.display = (i===n ? 'block' : 'none')); 
            document.querySelectorAll('.nav-link').forEach((l,i) => l.classList.toggle('active', i===n));
        };
        window.move = (dir, id) => { let s = document.getElementById(id); let n = s.selectedIndex + dir; if(n >= 1 && n < s.options.length) { s.selectedIndex = n; s.dispatchEvent(new Event('change')); } };

        // AUTH
        window.handleRegister = () => {
            const u = document.getElementById('reg-username').value.trim();
            const p = document.getElementById('reg-password').value.trim();
            if(!u || !p) return;
            set(ref(dbRT, 'users/' + u), { pass: p, role: 'student' }).then(() => { alert("Сәтті! Кіріңіз."); toggleAuth('login'); });
        };

        window.handleLogin = () => {
            const u = document.getElementById('login-username').value.trim();
            const p = document.getElementById('login-password').value.trim();
            get(child(ref(dbRT), `users/${u}`)).then((s) => {
                if(s.exists() && s.val().pass === p) loginSuccess(u, s.val().role);
                else alert("Қате!");
            });
        };

        function loginSuccess(name, role) {
            currentUser = name; isAdmin = (role === 'admin');
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-display').innerText = name;
            if(isAdmin) document.getElementById('admin-badge').classList.remove('hidden');
            loadProgress(); listenReviews();
        }

        window.logout = () => location.reload();

        // ҚАРА СӨЗДЕР МЕН КОМИКСТЕР
        window.loadContent = (n) => {
            if(!n) return;
            document.getElementById('soz-view').innerHTML = `
                <div class="video-box"><video controls><source src="assets/videos/soz_${n}.mp4"></video></div>
                <div class="text-box"><h3>№${n} Қара сөз</h3><p>${sozderContent[n] || "Мәтін табылмады"}</p></div>`;
        };
        window.loadComic = (n) => {
            if(!n) return;
            document.getElementById('comic-view').innerHTML = `<img src="assets/comics/comic_${n}.jpg" style="max-width:100%; border-radius:10px;" onerror="this.src='https://via.placeholder.com/600x400?text=Комикс+№${n}'">`;
        };

        // ТЕСТТЕР
        let qIdx = 0, qScore = 0;
        window.loadQuiz = (n) => {
            if(!n) return;
            qIdx = 0; qScore = 0;
            document.getElementById('quiz-container').classList.remove('hidden');
            renderQ(n);
        };
        function renderQ(n) {
            const quiz = db[n]; const q = quiz.q[qIdx];
            let html = `<h3>Сұрақ ${qIdx+1}/${quiz.q.length}</h3><p>${q.q}</p><div id="opts"></div>`;
            document.getElementById('quiz-active-area').innerHTML = html;
            const area = document.getElementById('opts');
            if(quiz.type === "yesno") ["Иә", "Жоқ"].forEach(o => area.appendChild(createOpt(o, o===q.c, n)));
            else q.o.forEach((o, i) => area.appendChild(createOpt(o, i===q.c, n)));
        }
        function createOpt(txt, isC, n) {
            const b = document.createElement('button'); b.className = "quiz-option"; b.innerText = txt;
            b.onclick = () => {
                if(isC) { b.classList.add('correct'); qScore++; } else b.classList.add('wrong');
                setTimeout(() => {
                    qIdx++; if(qIdx < db[n].q.length) renderQ(n); else finishQuiz(n);
                }, 1000);
            };
            return b;
        }
        function finishQuiz(n) {
            const total = db[n].q.length; const per = Math.round(qScore/total*100);
            set(ref(dbRT, `progress/${currentUser}/${n}`), qScore);
            document.getElementById('quiz-active-area').innerHTML = `<div class="score-circle">${per}%</div><h3>Нәтиже: ${qScore}/${total}</h3><button class="btn" onclick="loadQuiz(${n})">Қайта тапсыру</button>`;
        }

        // ПРОГРЕСС
        function loadProgress() {
            onValue(ref(dbRT, `progress/${currentUser}`), (s) => {
                const data = s.val() || {}; const count = Object.keys(data).length;
                document.getElementById('global-progress').style.width = (count/45*100) + "%";
                document.getElementById('progress-text').innerText = count + "/45 сөз";
            });
        }

        // ПІКІРЛЕР
        window.sendReview = () => {
            const txt = document.getElementById('review-input').value.trim();
            if(!txt) return;
            push(ref(dbRT, 'reviews'), { user: currentUser, text: txt, date: new Date().toLocaleString(), reply: null });
            document.getElementById('review-input').value = "";
        };
        function listenReviews() {
            onValue(ref(dbRT, 'reviews'), (s) => {
                const data = s.val(); const list = document.getElementById('reviews-list');
                if(!data) { list.innerHTML = "Пікірлер жоқ"; return; }
                list.innerHTML = Object.entries(data).reverse().map(([id, r]) => `
                    <div class="review-card">
                        <b>${r.user}</b> <small>${r.date}</small><div>${r.text}</div>
                        ${r.reply ? `<div class="admin-reply-box"><b>Админ:</b> ${r.reply}</div>` : ''}
                        ${isAdmin && !r.reply ? `<input type="text" id="rep-${id}" placeholder="Жауап..."><button onclick="reply('${id}')">Жіберу</button>` : ''}
                    </div>`).join('');
            });
        }
        window.reply = (id) => {
            const txt = document.getElementById('rep-'+id).value;
            update(ref(dbRT, 'reviews/'+id), { reply: txt });
        };

        // БАСТАПҚЫ ОРНАТУЛАР
        const s1 = document.getElementById('soz-select'), s2 = document.getElementById('comic-select'), s3 = document.getElementById('quiz-select');
        [s1, s2, s3].forEach(s => s.add(new Option("--- Таңдаңыз ---", "")));
        for(let i=1; i<=45; i++) {
            s1.add(new Option(i + "-ші қара сөз", i));
            s2.add(new Option(i + "-ші комикс", i));
            s3.add(new Option(i + "-ші тест", i));
        }
        let txtIdx = 0; const msg = "Абай әлеміне қош келдіңіз!";
        function type() { if(txtIdx < msg.length) { document.getElementById('type-text').innerHTML += msg[txtIdx++]; setTimeout(type, 50); } else document.getElementById('start-btn').style.display='block'; }
        type();
    </script>
</body>
</html>
